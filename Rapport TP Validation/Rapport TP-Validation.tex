\documentclass[a4paper,12pt]{report}
% Alternative Options:
%	Paper Size: a4paper / a5paper / b5paper / letterpaper / legalpaper / executivepaper
% Duplex: oneside / twoside
% Base Font Size: 10pt / 11pt / 12pt

\usepackage[export]{adjustbox}

\usepackage{geometry}
%% Language %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\usepackage[USenglish]{babel} %francais, polish, spanish, ...
\usepackage[francais]{babel}
\usepackage[T1]{fontenc}
\usepackage[latin1]{inputenc}

\usepackage{verbatim}
\usepackage{lmodern} %Type1-font for non-english texts and characters


%% Packages for Graphics & Figures %%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage{graphicx} %%For loading graphic files
%\usepackage{subfig} %%Subfigures inside a figure
%\usepackage{pst-all} %%PSTricks - not useable with pdfLaTeX

%% Please note:
%% Images can be included using \includegraphics{Dateiname}
%% resp. using the dialog in the Insert menu.
%% 
%% The mode "LaTeX => PDF" allows the following formats:
%%   .jpg  .png  .pdf  .mps
%% 
%% The modes "LaTeX => DVI", "LaTeX => PS" und "LaTeX => PS => PDF"
%% allow the following formats:
%%   .eps  .ps  .bmp  .pict  .pntg


%% Math Packages %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{amsfonts}


%% Line Spacing %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage{setspace}
%\singlespacing        %% 1-spacing (default)
%\onehalfspacing       %% 1,5-spacing
%\doublespacing        %% 2-spacing
\usepackage{listings}
\lstset{language=C++} 
\usepackage{color}

\definecolor{mygreen}{rgb}{0,0.6,0}
\definecolor{mygray}{rgb}{0.5,0.5,0.5}
\definecolor{mymauve}{rgb}{0.58,0,0.82}

\lstset{ %
  backgroundcolor=\color{white},   % choose the background color; you must add \usepackage{color} or \usepackage{xcolor}
  basicstyle=\footnotesize,        % the size of the fonts that are used for the code
  breakatwhitespace=false,         % sets if automatic breaks should only happen at whitespace
  breaklines=true,                 % sets automatic line breaking
  captionpos=b,                    % sets the caption-position to bottom
  commentstyle=\color{mygreen},    % comment style
  deletekeywords={...},            % if you want to delete keywords from the given language
  escapeinside={\%*}{*)},          % if you want to add LaTeX within your code
  extendedchars=true,              % lets you use non-ASCII characters; for 8-bits encodings only, does not work with UTF-8
  frame=single,                    % adds a frame around the code
  keepspaces=true,                 % keeps spaces in text, useful for keeping indentation of code (possibly needs columns=flexible)
  keywordstyle=\color{blue},       % keyword style
  language=C++,                 % the language of the code
  otherkeywords={*,...},            % if you want to add more keywords to the set
  numbers=left,                    % where to put the line-numbers; possible values are (none, left, right)
  numbersep=5pt,                   % how far the line-numbers are from the code
  numberstyle=\tiny\color{mygray}, % the style that is used for the line-numbers
  rulecolor=\color{black},         % if not set, the frame-color may be changed on line-breaks within not-black text (e.g. comments (green here))
  showspaces=false,                % show spaces everywhere adding particular underscores; it overrides 'showstringspaces'
  showstringspaces=false,          % underline spaces within strings only
  showtabs=false,                  % show tabs within strings adding particular underscores
  stepnumber=2,                    % the step between two line-numbers. If it's 1, each line will be numbered
  stringstyle=\color{mymauve},     % string literal style
  tabsize=2,                       % sets default tabsize to 2 spaces
  title=\lstname                   % show the filename of files included with \lstinputlisting; also try caption instead of title
}







%% NOTE POUR CLEMENT : UTILISE LE HEADER CI-DESSUS, IL EST MEILLEUR

%%AJOUTS DE CLEMENT DANS LE HEADER :
\usepackage{fancyhdr}
\pagestyle{fancy}
\lhead{Clément BLANQUET et Rafik CHENNOUF}
\rhead{Page \thepage}
\cfoot{\footnotesize{MI11 - Rapport de TP : Modélisation AADL et ordonnancement}}
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0.4pt}

\usepackage{titlesec}
\makeatletter
\titleformat{\chapter}[frame]
  {\normalfont}{\filright\enspace \@chapapp~\thechapter\enspace}
  {15pt}{\LARGE\bfseries\filcenter}
\titlespacing*{\chapter}
  {0pt}{0pt}{20pt}
\makeatother

\renewcommand{\thesection}{}
\renewcommand{\thesubsection}{\arabic{section}.\arabic{subsection}}
\makeatletter
\def\@seccntformat#1{\csname #1ignore\expandafter\endcsname\csname the#1\endcsname\quad}
\let\sectionignore\@gobbletwo
\let\latex@numberline\numberline
\def\numberline#1{\if\relax#1\relax\else\latex@numberline{#1}\fi}
\makeatother




\author{Clément BLANQUET et Rafik CHENNOUF}
\title{MI11 - Rapport de TP : Modélisation AADL et ordonnancement}

\begin{document}

\begin{titlepage}

	\centering
	\includegraphics[width=0.15\textwidth]{sigle_UTC.jpg}\par\vspace{1cm}
	{\scshape\LARGE Université de Technologie de Compiègne \par\vspace{1cm}}	
	{\scshape\Large MI11\par}
	\vspace{1.5cm}
	{\huge\bfseries Rapport de TP : Modélisation AADL et ordonnancement\par}
	\vspace{2cm}
	{\Large\itshape Clément BLANQUET et Rafik CHENNOUF\par}
	\vspace{2cm}
	\vfill
% Bottom of the page
	{\large Juin 2017}
\end{titlepage}


\renewcommand{\contentsname}{Sommaire} % Changer le nom de la table des matieres
\tableofcontents
% Les différentes tables
\listoffigures        % Liste des figures





\chapter{Exercice 3 : Moniteur médical multi-paramètres}

\section{Question 1}

On peut déterminer la priorité selon la plus petite période (Rate Monotonic), le plus petit temps de réponse dynamique (Earliest Deadline First) ou encore la plus petite laxité dynamique (Least Laxity First).
On a décidé de choisir comme premier critère la période de la tâche (plus elle est petite, plus la tâche est prioritaire => Rate Monotonic) et en second critère, c'est à dire en cas d'égalité, la durée d'exécution de la tâche (plus elle est grande,  plus la tâche est prioritaire).\newline

Les paramètres et les priorités des différentes tâches à ordonnancer sont donnés dans le tableau ci-dessous :

\begin{center}
\begin{tabular}{|c|c|c|c|}

\hline
Tâches & Période (ms) & Capacité (ms) & Priorité\\
\hline
getPA & 10 & 1 & 3\\
\hline
getSO2 & 10 & 2 & 2\\
\hline
getECG & 40 & 4 & 5\\
\hline
dpy & 6 & 1 & 1\\
\hline
check & 12 & 2 & 4\\
\hline

\end{tabular}
\end{center}

La tâche la plus prioritaire est la tâche \textbf{dpy} car elle a la période la plus petite (6 ms). Les tâches de priorité 2 et 3 sont respectivement les tâches \textbf{getSO2} et \textbf{getPA}. Ces deux tâches ayant la même période (10 ms), la tâche la plus prioritaire est celle avec une capacité supérieure, c'est à dire ici la tâche \textbf{getSO2}. La tâche de priorité 4 est la tâche \textbf{check} avec une période de 12 ms. Enfin, la tâche la moins prioritaire est la tâche \textbf{getECG} car elle possède la période la plus élevée.\newline


\section{Question 2}

Nous avons implémenté les paramètres précédents dans le fichier AADL \textit{health\_monitor.aadl} comme ci-dessous :

\begin{lstlisting}
-- getPA
thread implementation read_sensor.PA
	properties
		Dispatch_Protocol => Periodic ;
		Period => 10 ms;
		Compute_Execution_Time => 1 ms .. 1 ms;
		Deadline => 10 ms;
		Cheddar_Properties::Dispatch_Absolute_Time => 0 ms;
		Cheddar_Properties::Fixed_Priority => 253;	
end read_sensor.PA;

-- getECG
thread implementation read_sensor.ECG
	properties
		Dispatch_Protocol => Periodic ;
		Period => 40 ms;
		Compute_Execution_Time => 4 ms .. 4 ms;
		Deadline => 40 ms;
		Cheddar_Properties::Dispatch_Absolute_Time => 0 ms;
		Cheddar_Properties::Fixed_Priority => 251;
end read_sensor.ECG;

-- getSO2
thread implementation read_sensor.SO2
	properties
		Dispatch_Protocol => Periodic ;
		Period => 10 ms;
		Compute_Execution_Time => 2 ms .. 2 ms;
		Deadline => 10 ms;
		Cheddar_Properties::Dispatch_Absolute_Time => 0 ms;
		Cheddar_Properties::Fixed_Priority => 254;
end read_sensor.SO2;

-- check
thread implementation check_bounds.impl
	properties
		Dispatch_Protocol => Periodic ;
		Period => 12 ms;
		Compute_Execution_Time => 2 ms .. 2 ms;
		Deadline => 12 ms;
		Cheddar_Properties::Dispatch_Absolute_Time => 0 ms;
		Cheddar_Properties::Fixed_Priority => 252;
end check_bounds.impl;

-- dpy
thread implementation display.impl
	properties
		Dispatch_Protocol => Periodic ;
		Period => 6 ms;
		Compute_Execution_Time => 1 ms .. 1 ms;
		Deadline => 6 ms;
		Cheddar_Properties::Dispatch_Absolute_Time => 0 ms;
		Cheddar_Properties::Fixed_Priority => 255;
end display.impl;

\end{lstlisting}

\section{Question 3}


\begin{figure}[h]
	\centering
		\includegraphics[width=1\textwidth]{screens/exo3_Q3.png}
		\caption{Résultat de l'ordonnancement avec Cheddar}
\end{figure}

\begin{figure}[h]
	\centering
		\includegraphics[width=1\textwidth]{screens/exo3_Q3_cheddar.png}
		\caption{Tâches ordonnançables}
\end{figure}

On voit bien sur Cheddar que toutes nos tâches sont ordonnançables.

\section{Question 4}

En ajoutant un second processeur et en modifiant les paramètres des tâches en fonction de ce qui est donné dans le nouveau tableau, on remarque que les tâches ne respectent plus leurs contraintes temporelles. En effet, d'après Cheddar, la tâche \textbf{getPA} ne s'exécute plus du tout comme on peut le voir sur la copie d'écran suivante :\newline

\begin{figure}[h]
	\centering
		\includegraphics[width=1\textwidth]{screens/exo3_Q4.png}
		\caption{Résultat de l'ordonnancement avec Cheddar avec deux processeurs}
\end{figure}

Ceci est dû au fait que les tâches \textbf{getPA} et \textbf{getSO2} ont exactement la même période et la même capacité. Comme nous avons décidé arbitrairement que la tâche \textbf{getSO2} est prioritaire sur la tâche \textbf{getPA}, cette tâche ne pourra jamais s'exécuter puisqu'à chaque fois que la tâche \textbf{dpy} aura terminé son exécution, c'est la tâche \textbf{getSO2} qui reprendra la main.

\section{Question 5}

Étant donné que la tâche \textbf{getPA} ne peut pas s'exécuter et que le processeur b est deux fois plus rapide que le processeur a, une solution simple serait de déplacer la tâche \textbf{getPA} vers le processeur b. Ceci permet d'alléger la charge de travail du processeur a et de permettre aux tâches \textbf{getPA} et \textbf{getSO2} d'être complètement indépendantes. 
Il faut aussi diviser la capacité initiale de la tâche \textbf{getPA} par 2 ce qui donne 1.

\begin{center}
\begin{tabular}{|c|c|c|c|}

\hline
Tâches & Processeur & Capacité & Période\\
\hline
check & b & 4 & 6\\
\hline
getECG & b & 2 & 20\\
\hline
getPA & b & 1 & 5\\
\hline
dpy & a & 2 & 3\\
\hline
getSO2 & a & 2 & 5\\
\hline

\end{tabular}
\end{center}

Une deuxième solution aurait été de former un jeu de tâches harmoniques comme dans l'exercice 1. On cherche dans notre tableau des tâches qui possèdent des périodes multiples entre elles et on les regroupe sur le même processeur. Dans notre cas, on aurait pu regrouper les tâches \textbf{check} et \textbf{dpy} de périodes 6 et 3 sur le processeur b et les tâches \textbf{getPA}, \textbf{getSO2} et \textbf{getECG} de périodes 5, 5 et 20 sur le processeur a.

\newpage

\section{Question 6}

\begin{figure}[h]
	\centering
		\includegraphics[width=1\textwidth]{screens/exo3_Q6.png}
		\caption{Résultat de l'ordonnancement avec Cheddar avec deux processeurs sachant que la tâche \textbf{getPA} s'exécute sur b}
\end{figure}

On voit que cette solution permet à toutes les tâches de s'exécuter.
Ci-dessous le code AADL complet :\newline


\begin{lstlisting}
-----------------------
-- Composants matériels
-----------------------

-- Bus

-- Les capteurs sont sur bus CAN
bus CAN
end CAN;

-- L''afficheur est sur bus LVDS
bus LVDS
end LVDS;


-- Capteurs

-- Capteur saturation O2
device SO2_sensor
  features
    SO2 : out data port;
    iobus : requires bus access CAN;
end SO2_sensor;

device implementation SO2_sensor.impl
end SO2_sensor.impl;

-- Capteur électrocardiogramme
device ECG_sensor
  features
    ECG : out data port;
    iobus : requires bus access CAN;
end ECG_sensor;

device implementation ECG_sensor.impl
end ECG_sensor.impl;

-- Capteur Pression artérielle
device PA_sensor
  features
    PA : out data port;
    iobus : requires bus access CAN;
end PA_sensor;

device implementation PA_sensor.impl
end PA_sensor.impl;

-- Autres périphériques
device LCD_display
  features
    fb : in data port;					-- framebuffer
    lvds : requires bus access LVDS;	-- lcd bus
end LCD_display;
  
device Alarm
  features
    trigger : in event data port;
    iobus : requires bus access CAN;
end Alarm;

-- Processeur
processor armadeus
  features
    iobus : requires bus access CAN;
    lvds : requires bus access LVDS;
end armadeus;

processor implementation armadeus.impl
	properties 
		Scheduling_Protocol => POSIX_1003_HIGHEST_PRIORITY_FIRST_PROTOCOL;
		Cheddar_Properties::Preemptive_Scheduler => True ;
end armadeus.impl;

processor armadeus2
  features
    iobus : requires bus access CAN;
    lvds : requires bus access LVDS;
end armadeus2;

processor implementation armadeus2.impl	-- NOUVEAU CPU
	properties 
		Scheduling_Protocol => POSIX_1003_HIGHEST_PRIORITY_FIRST_PROTOCOL;
		Cheddar_Properties::Preemptive_Scheduler => True ;
end armadeus2.impl;

-----------------------
-- Composants logiciels
-----------------------
thread read_sensor
  features
    raw : in data port;
    cooked : out data port;
end read_sensor;

thread implementation read_sensor.PA
	properties
		Dispatch_Protocol => Periodic ;
		Period => 5 ms;
		Compute_Execution_Time => 1 ms .. 1 ms;
		Deadline => 5 ms;
		Cheddar_Properties::Dispatch_Absolute_Time => 0 ms;
		Cheddar_Properties::Fixed_Priority => 253;	
end read_sensor.PA;

thread implementation read_sensor.ECG
	properties
		Dispatch_Protocol => Periodic ;
		Period => 20 ms;
		Compute_Execution_Time => 2 ms .. 2 ms; 
		Deadline => 20 ms;
		Cheddar_Properties::Dispatch_Absolute_Time => 0 ms;
		Cheddar_Properties::Fixed_Priority => 251;
end read_sensor.ECG;

thread implementation read_sensor.SO2
	properties
		Dispatch_Protocol => Periodic ;
		Period => 5 ms;
		Compute_Execution_Time => 2 ms .. 2 ms;
		Deadline => 5 ms;
		Cheddar_Properties::Dispatch_Absolute_Time => 0 ms;
		Cheddar_Properties::Fixed_Priority => 254;
end read_sensor.SO2;

thread check_bounds
  features
    PA : in data port;
    ECG : in data port;
    SO2 : in data port;
    alarm : out event data port;
end check_bounds;

thread implementation check_bounds.impl
	properties
		Dispatch_Protocol => Periodic ;
		Period => 6 ms;
		Compute_Execution_Time => 4 ms .. 4 ms; 
		Deadline => 6 ms;
		Cheddar_Properties::Dispatch_Absolute_Time => 0 ms;
		Cheddar_Properties::Fixed_Priority => 252;
end check_bounds.impl;

thread display
  features
    PA : in data port;
    ECG : in data port;
    SO2 : in data port;
    fb : out data port;
end display;

thread implementation display.impl
	properties
		Dispatch_Protocol => Periodic ;
		Period => 3 ms;
		Compute_Execution_Time => 2 ms .. 2 ms;
		Deadline => 3 ms;
		Cheddar_Properties::Dispatch_Absolute_Time => 0 ms;
		Cheddar_Properties::Fixed_Priority => 255;
end display.impl;

process health_monitoring
  features
    PA : in data port;
    ECG : in data port;
    SO2 : in data port;
    fb : out data port;
    alarm : out event data port;
end health_monitoring;


process implementation health_monitoring.impl
  subcomponents
    getSO2 : thread read_sensor.SO2;
    dpy : thread display.impl;
end health_monitoring.impl;


process health_monitoring2
  features
    PA : in data port;
    --ECG : in data port;
    SO2 : in data port;
    fb : out data port;
    alarm : out event data port;
end health_monitoring2;


process implementation health_monitoring2.impl -- NOUVELLE APPLICATION
  subcomponents
    getECG : thread read_sensor.ECG;
    check : thread check_bounds.impl;
    getPA : thread read_sensor.PA;
end health_monitoring2.impl;

------------------
-- système complet
------------------
system health_monitor
end health_monitor;

system implementation health_monitor.impl
  subcomponents
    -- Les bus
    can : bus CAN;
    lvds : bus LVDS;
    
    -- Les processeurs
    cpu_a : processor armadeus.impl;
    cpu_b : processor armadeus2.impl;	-- NOUVEAU CPU
    
    -- Les capteurs
    SO2_sense : device SO2_sensor;
    PA_sense : device PA_sensor;
    ECG_sense : device ECG_sensor;
    
    -- Les périphériques de sortie
    lcd : device LCD_display;
    alarm : device Alarm;
    
    -- L''application
    appli : process health_monitoring.impl;
    appli2 : process health_monitoring2.impl;		-- NOUVELLE APPLICATION
    
    
  connections
    -- connexions de bus
    bus access can -> SO2_sense.iobus;
    bus access can -> PA_sense.iobus;
    bus access can -> ECG_sense.iobus;
    bus access can -> alarm.iobus;
    bus access can -> cpu_a.iobus;
       
    bus access lvds -> lcd.lvds;
    bus access lvds -> cpu_a.lvds;
  
    -- connexions de ports
    so2_conn : data port SO2_sense.SO2 -> appli.SO2;
    pa_conn : data port PA_sense.PA -> appli.PA;
    ecg_conn : data port ECG_sense.ECG -> appli.ECG;
    fb_conn : data port appli.fb -> lcd.fb;
    alarm_conn : event data port appli.alarm -> alarm.trigger;
    
  properties
    -- Allocation logiciel - plateforme d''exécution
    Actual_Processor_Binding => reference cpu_a applies to appli;
    Actual_Processor_Binding => reference cpu_b applies to appli2;	-- NOUVEAU CPU
    
    Actual_Connection_Binding => reference can applies to so2_conn;
    Actual_Connection_Binding => reference can applies to pa_conn;
    Actual_Connection_Binding => reference can applies to ecg_conn;
    Actual_Connection_Binding => reference can applies to alarm_conn;
    Actual_Connection_Binding => reference lvds applies to fb_conn;
end health_monitor.impl;
\end{lstlisting}


\end{document}

